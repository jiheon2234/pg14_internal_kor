
## Value Insertion

새로운 튜플이 힙 페이지에 추가될 때, 해당 인덱스 범위의 요약 정보가 업데이트된다. [^1] 범위 번호는 페이지 번호를 사용해 간단한 산술 연산으로 계산되며, 이후 범위 맵을 통해 요약 정보를 찾는다.

현재 요약 정보가 확장되어야 하는지를 결정하기 위해, 추가 함수가 사용된다.
확장이 필요하고 페이지에 충분한 여유 공간이 있다면, (새로운 인덱스 항목을 추가하지 않고) 제 자리에서 확장이 이루어진다.

예를 들어, 값 42를 가진 튜플을 페이지 13에 추가했다고 생각하자. 범위 번호는 페이지 번호를 범위 크기로 나눈 정수 나눗셈을 통해 계산된다.
범위 크기가 4라고 했을 때, 범위 번호는 3이 된다. 0부터 번호를 세기 때문에, 우리는 범위 맵의 4번째 포인터를 사용한다.
해당 범위의 최솟값은 31이고, 최댓값은 40이다. 추가된 값이 이 범위를 벗어나므로, 최댓값이 증가한다.

![](image/Pasted%20image%2020241031150825.png)

제자리에서 업데이트가 불가능한 경우, 새로운 인덱스 항목이 추가되고 범위 맵도 수정된다.

## Range Summarization

위에서 설명한 모든 내용은 새로운 튜플이 이미 요약된 범위 내에 추가될 때 적용된다. 인덱스가 새로 생성될 땐 기존 범위가 모두 요약되지만, 테이블이 확장되면서 새로운 페이지들이 기존 범위 밖으로 추가될 수 있다.

인덱스가 *autosummarize* 저장 매개변수를 활성화한 상태로 생성되면, 새로운 범위가 즉시 요약된다. 하지만 데이터 웨어하우스처럼, 대량의 행이 한 번에 추가되는 환경에서는 이 모드가 삽입 속도를 크게 저하시킬 수 있다.

디폴트로, 새 범위는 즉시 요약되지 않는다. 요약 정보가 없는 범위는 항상 스캔되므로, 이는 인덱스의 정확성에 영향을 미치지 않는다.
요약 작업은 비동기적으로 수행되며, vacuuming중이나 *brin_summarize_new_values* 함수를 호출하여 수동으로 (또는 단일 범위를 처리하는*brin_summarize_range* 함수를 사용하여) 실행할 수 있다.

범위 요약[^2] 작업은 테이블을 잠그지 않는다. 이 과정의 시작 단계에서, 해당 범위에 대한 플레이스홀더 항목이 인덱스에 삽입된다.
만약 범위가 스캔되는 동안 데이터가 변경되면, 플레이스홀더는 이 변경을 반영한 요약 정보로 업데이트된다.
이후 유니온 함수가 이 데이터를 해당 범위의 기존 요약 정보와 결합한다.

이론적으로, 일부 행이 삭제되면 요약 정보가 줄어들 수 있지만, Gist 인덱스가 페이지 분할 후 데이터를 재배치할 수 있는 것과 달리, BRIN의 요약 정보는 줄어들지 않고 확장만 가능하다.
일반적으로는 요약 정보 축소가 필요하지 않는데, 데이터 저장소가 주로 새로운 데이터를 추가하는 용도로만 사용되기 때문이다.
특정 범위의 요약 정보를 삭제하고 다시 요약하려면 *brin_desummarize_range* 함수를 호출할 수 있지만, 어떤 범위에서 이 작업이 유리할지에 대한 정보는 없다.

그러므로, BRIN 인덱스는 주로 매우 큰 크기의 테이블을 대상으로 하며, 주로 파일 끝에 새로운 행을 추가하는 최소한의 업데이트만 있거나, 전혀 업데이트되지 않는 테이블에 적합하다.
이 인덱스는 주로 데이터 웨어하우스에서 분석 보고서를 작성하는 데 사용된다.






[^1]:[ backend/access/brin/brin.c, brininsert function](https://git.postgresql.org/gitweb/?p=postgresql.git;a=blob;f=src/backend/access/brin/brin.c;hb=REL_14_STABLE)
[^2]:[ backend/access/brin/brin.c, summarize_range function](https://git.postgresql.org/gitweb/?p=postgresql.git;a=blob;f=src/backend/access/brin/brin.c;hb=REL_14_STABLE)