
**Gist**(Generalized Search Tree) [^1] 는 상대적 위치 지정이 가능한 데이터 타입에 대해 균형 검색 트리를 일반화한 접근 방식이다. B-tree는 비교 연산이 가능한 순서형 타입에 제한적으로 적용된다(이 점에서는 매우 효율적이다). 그러나 GIST에는 연산자 클래스를 통해 데이터를 트리에 분포시키는 임의의 기준을 정의할 수 있다.
Gist 인덱스는 공간 데이터를 위한 R-tree, 집합을 위한 RD-tree, 텍스트나 이미지 같은 임의 데이터 타입을 위한 signature tree등을 모두 포함할 수 있다.

확장성 덕분에, 인덱싱 엔진의 인터페이스를 구현하여 새로운 접근 방식을 만들 수 있다.
그러나, 인덱싱 논리를 설계하는 것 외에도 페이지 레이아웃 , 효율적인 lock 전략, WAL 지원을 정의해야 한다. 이는 높은 프로그래밍 능력과 상당한 구현 노력이 필요하다.
Gist는 이러한 작업을 간소화하여, 저수준 기술의 세부 사항을 처리하고 검색 알고리즘의 기반을 제공한다. 새로운 데이터 타입에 대해 Gist 방식을 사용하려면, 10여개 지원 함수가 포함된 새로운 연산자 클래스를 추가하기만 하면 된다.

B-tree에 제공되는 단순한 연산자 클래스와 달리, 이런 클래스들은 인덱싱 논리의 대부분을 포함한다. 이 관점에서 Gist는 새로운 접근 방식을 구축하기 위한 프레임워크로 볼 수 있다.

가장 일반적인 용어로 설명하자면, 리프 노드에 속하는 각 항목(leaf entry)는 *predicate*(논리적 조건)과 힙 튜플 ID를 포함한다. 
인덱스 키는 이 조건을 만족해야 하며; 키 자체가 이 엔트리의 일부인지 여부는 중요하지 않다.

내부 리프의 각 항목은 역시 조건과 자식 노드에 대한 참조를 포함한다; 해당 자식 서브트리의 모든 인덱스 데이터는 이 조건을 만족해야 한다.
다른 말로, 내부 엔트리의 조건은 자식 엔트리들의 모든 조건의 합집합이 된다. Gist의 이러한 속성은 B-trees에서 사용되는 단순 랭킹에 적합하도록 설계되었다.

Gist 트리 검색은 *일관성 함수*(consistency function)에 의존하며, 이는 연산자 클래스에서 정의된 지원 함수 중 하나이다.

일관성 함수는 인덱스 항목이 검색 조건과 "일치하는지" 판단하기 위해 호출된다. 
내부 엔트리의 경우, 해당 서브트리로 내려가야 할지를 결정하고, 리프 엔트리의 경우, 해당 인덱스 키가 조건을 만족하는지 확인한다.

검색은 일반적 트리처럼 루트에서 시작한다.[^2]
일관성 함수는 탐색할 자식 노드와 건너뛸 자식 노드를 결정한다.
이 과정은 찾은 각 자식 노드에 대해 반복되며; B-tree와 달리 Gist 인덱스에서는 여러 자식 노드를 탐색할 수 있다. 일관성 함수에 의해 선택된 리프 노드 엔트리들이 검색 결과로 반환된다.

검색은 항상 DFS이다 : 알고리즘은 가능한 한 빨리 리프 페이지에 도달하려고 시도한다.
따라서, 첫 몇 개의 결과 행만 필요한 경우, 즉시 결과를 반환하기 시작할 수 있어 효율적이다.

Gist 트리에 새로운 값을 삽입할 때에는 일관성 함수를 사용할 수 없다. 정확히 하나의 노드를 선택해 내려가야 하기 때문이다. [^3] 이 노드는 삽입 비용이 최소인 노드여야 하며, 연산자 클래스의 페널티 함수에 의해 결정된다.

B-tree와 마찬가지로, 선택된 노드에 공간이 부족하면 분할이 발생할 수 있다.[^4] 이 분할 작업에는 두 추가 함수가 필요하다.
하나는 기존 노드와 새 노드 간에 항목을 분배하며, 다른 하나는 두 조건의 합집합을 만들어 부모 노드의 조건을 업데이트한다.

새로운 값이 추가되면서, 기존 조건들이 점점 확장되며, 이는 보통 페이지가 분할되거나 인덱스 전체가 재구성될 때만 축소된다. 따라서, Gist 인덱스를 자주 업데이트하면 성능이 저하될 수 있다.

이러한 이론적 논의는 다소 모호해 보이며, 구체적인 로직은 특정 연산자 클래스에 따라 다르므로, 몇 가지 구체적인 예를 통해 알아보자.









[^1]:*범용 검색 트리*  https://www.postgresql.org/docs/14/gist.html
[^2]:[backend/access/gist/gistget.c, gistgettuple function]https://git.postgresql.org/gitweb/?p=postgresql.git;a=blob;f=src/backend/access/gist/gistget.c;hb=REL_14_STABLE
[^3]:[backend/access/gist/gistutil.c, gistchoose function](https://git.postgresql.org/gitweb/?p=postgresql.git;a=blob;f=src/backend/access/gist/gistutil.c;hb=REL_14_STABLE)
[^4]:[backend/access/gist/gistsplit.c, gistSplitByKey function](https://git.postgresql.org/gitweb/?p=postgresql.git;a=blob;f=src/backend/access/gist/gistsplit.c;hb=REL_14_STABLE)